#include "mainwindow.h"
#include "infowindow.h"
#include "packetids.h"
#include <QApplication>
#include <QCheckBox>
#include <QCoreApplication>
#include <QDateTime>
#include <QGroupBox>
#include <QHeaderView>
#include <QIcon>
#include <QLayout>
#include <QMenu>
#include <QMenuBar>
#include <QMessageBox>
#include <QProcess>
#include <QRadioButton>
#include <QSettings>
#include <QStyle>
#include <QTableWidget>
#include <QTextEdit>
#include <QTimeEdit>

MainWindow::MainWindow(QWidget *parent) : QMainWindow(parent)
{
    setMinimumSize(999, 333);
    central = new QWidget(this);
    setCentralWidget(central);
    initWelcomeScreen();
    setWindowTitle("–ê–£–ö–†–° v0");
}

MainWindow::~MainWindow()
{
}

// –æ–∫–Ω–æ –≤—Ö–æ–¥–∞
void MainWindow::initWelcomeScreen()
{
    textInputWithIp = new QLineEdit(this);
    textInputWithIp->setFixedWidth(350);
    QString hint = "–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ip:port";
    textInputWithIp->setPlaceholderText(hint);
    textInputWithIp->setToolTip(hint);
    QHBoxLayout *hlayout = new QHBoxLayout();
    button = new QPushButton("–°—Ç–∞—Ä—Ç", this);
    QIcon::setThemeName(QIcon::fallbackThemeName());
    button->setIcon(QIcon::fromTheme("emblem-mounted"));
    hlayout->addStretch();
    hlayout->addWidget(textInputWithIp, 0, Qt::AlignCenter);
    hlayout->addWidget(button, 0, Qt::AlignCenter);
    hlayout->addStretch();
    connect(textInputWithIp, &QLineEdit::returnPressed, this, &MainWindow::hideWelcomeScreen);
    connect(button, &QPushButton::clicked, this, &MainWindow::hideWelcomeScreen);
    QSettings settings("QTSettings");
    QString savedIp = settings.value("serverAddress", "").toString();
    if (!savedIp.isEmpty())
    {
        textInputWithIp->setText(savedIp);
    }
    QVBoxLayout *vlayout = new QVBoxLayout(central);
    QLabel *label = new QLabel("–ê–£–ö–†–°", this);
    label->setStyleSheet("font: 24pt; font-weight: bold;");
    label->setAlignment(Qt::AlignCenter);
    vlayout->addStretch();
    vlayout->addWidget(label, 0, Qt::AlignHCenter);
    vlayout->addSpacing(5);
    vlayout->addLayout(hlayout);
    vlayout->addStretch();
}

// —É–±–∏—Ä–∞–µ–º —ç–∫—Ä–∞–Ω –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π + –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
void MainWindow::hideWelcomeScreen()
{
    QStringList parts = textInputWithIp->text().split(":");
    if (parts.length() != 2 || parts[1].length() > 5 || parts[1].length() < 3)
    {
        textInputWithIp->setStyleSheet("background-color: darkred");
        return;
    }
    QSettings settings("QTSettings");
    settings.setValue("serverAddress", textInputWithIp->text());
    button->deleteLater();
    textInputWithIp->deleteLater();
    delete central->layout();
    initMainScreen();
    initMenuBar();
    QString address = parts[0];
    quint16 port = parts[1].toUShort();
    network = new Network();
    connect(network, &Network::packetRecv, this, &MainWindow::onPacketRecv);
    connect(network, &Network::badConnection, this, &MainWindow::onBadConnection);
    logToPanel("–ò–¥—ë—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...");
    network->connectToServer(address, port);
}

// –º–µ–Ω—é –ø–æ–ª–æ—Å–∫–∏ –≤–≤–µ—Ä—Ö—É –ø—Ä–æ–≥—Ä–∞–º–º—ã
void MainWindow::initMenuBar()
{
    menuBar = new QMenuBar();
    QMenu *fileMenu = new QMenu("–ü—Ä–æ–≥—Ä–∞–º–º–∞");
    fileMenu->addAction("–í—ã—Ö–æ–¥", this, QApplication::exit);
    fileMenu->addAction("–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫", this, &MainWindow::restartApp);
    menuBar->addMenu(fileMenu);
    // QMenu *testMenu = new QMenu("–¢–µ—Å—Ç");
    // menuBar->addMenu(testMenu);
    layout()->setMenuBar(menuBar);

    QCheckBox *hideOffedArduinosCheckBox = new QCheckBox("–°–∫—Ä—ã–≤–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–¥—É–∏–Ω–æ", this);
    hideOffedArduinosCheckBox->setGeometry(270, 0, 400, 35);
    layout()->addWidget(hideOffedArduinosCheckBox);
    connect(hideOffedArduinosCheckBox, &QCheckBox::stateChanged, this, &MainWindow::checkBoxChanged);
}

// –Ω–∞ —á–µ–∫–±–æ–∫—Å –∫–ª–∏–∫–Ω—É–ª–∏
void MainWindow::checkBoxChanged(int state)
{
    bool checked = state == Qt::Checked;
    int rowCount = tableWidget->rowCount();
    for (int row = 0; row < rowCount; ++row)
    {
        QTableWidgetItem *statusItem = tableWidget->item(row, 2);
        if (statusItem->text() == "–û—Ñ—Ñ–ª–∞–π–Ω")
        {
            tableWidget->setRowHidden(row, checked);
        }
    }
}

// –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É
void MainWindow::restartApp()
{
    QProcess::startDetached(QCoreApplication::applicationFilePath(), QCoreApplication::arguments());
    QApplication::exit();
}

// –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∏—Ç —Ç–∞–±–ª–∏—Ü–∞ + –ª–æ–≥ –ø–∞–Ω–µ–ª—å
void MainWindow::initMainScreen()
{
    tableWidget = new QTableWidget();
    tableWidget->setColumnCount(7);
    tableWidget->setHorizontalHeaderLabels(
        {"ID", "–ó–∞–º–µ—Ç–∫–∞", "–°—Ç–∞—Ç—É—Å", "–í–æ–∑—Ä–∞—Å—Ç", "–¢–µ–º–ø. –ø–æ–º–µ—â–µ–Ω–∏—è", "–õ–µ–∂–∏—Ç", "–î–µ–π—Å—Ç–≤–∏—è"});
    tableWidget->horizontalHeaderItem(0)->setToolTip("ID Arduino");
    tableWidget->horizontalHeaderItem(0)->setIcon(QIcon::fromTheme("cpu"));
    tableWidget->horizontalHeaderItem(1)->setToolTip("–ó–∞–º–µ—Ç–∫–∞ –¥–ª—è —Å–µ–±—è");
    tableWidget->horizontalHeaderItem(1)->setIcon(QIcon::fromTheme("emblem-question"));
    tableWidget->horizontalHeaderItem(2)->setToolTip("–°—Ç–∞—Ç—É—Å —Å Arduino");
    tableWidget->horizontalHeaderItem(2)->setIcon(QIcon::fromTheme("package-new"));
    tableWidget->horizontalHeaderItem(3)->setToolTip("–í–æ–∑—Ä–∞—Å—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Arduino –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ");
    tableWidget->horizontalHeaderItem(3)->setIcon(QIcon::fromTheme("food-cake"));
    tableWidget->horizontalHeaderItem(4)->setToolTip("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏");
    tableWidget->horizontalHeaderItem(4)->setIcon(QIcon::fromTheme("colorfx"));
    tableWidget->horizontalHeaderItem(5)->setToolTip("–õ–µ–∂–∏—Ç –ª–∏?");
    tableWidget->horizontalHeaderItem(5)->setIcon(QIcon::fromTheme("data-information"));
    tableWidget->horizontalHeaderItem(6)->setToolTip("–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è");
    tableWidget->horizontalHeaderItem(6)->setIcon(QIcon::fromTheme("financial-list"));
    tableWidget->setColumnWidth(1, 150);
    tableWidget->setColumnWidth(4, 170);
    tableWidget->setColumnWidth(5, 85);
    tableWidget->showGrid();
    tableWidget->horizontalHeader()->setStretchLastSection(true);
    tableWidget->setEditTriggers(QAbstractItemView::NoEditTriggers);
    QVBoxLayout *layout = new QVBoxLayout();
    layout->setContentsMargins(2, 5, 2, 5);
    layout->addWidget(tableWidget, 2);
    logPanel = new QTextEdit();
    logPanel->setReadOnly(true);
    layout->addWidget(logPanel, 1);
    central->setLayout(layout);
    setCentralWidget(central);
}

// –ø–∏—à–µ—Ç –≤ –ª–æ–≥ –ø–∞–Ω–µ–ª—å —Å —Ç–∞–π–º—à—Ç–∞–º–ø–æ–º
void MainWindow::logToPanel(QString text, bool redText)
{
    QString timestamp = QDateTime::currentDateTime().toString("yyyy-MM-dd hh:mm:ss");
    QString lineText = "[" + timestamp + "] " + text;
    if (!redText)
    {
        logPanel->append(lineText);
    }
    else
    {
        logPanel->append("<span style='color: red'>" + lineText + "</span>");
    }
}

void MainWindow::onBadConnection()
{
    logToPanel("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è :(", true);
}

// –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–∫–µ—Ç–∞
void MainWindow::onPacketRecv(qint16 id, QStringList args)
{
    switch (id)
    {
    case PacketID_HI: {
        logToPanel("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!");
    }
    break;
    case PacketID_INIT_ROW: {
        tableWidget->insertRow(tableWidget->rowCount());
        int row = tableWidget->rowCount() - 1;
        bool isOffline = false;
        for (int i = 0; i < 6; ++i)
        {
            if (i == 1)
            {
                // —è—á–µ–π–∫–∞ –∑–∞–º–µ—Ç–∫–∞, –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                QLineEdit *noteLineEdit = new QLineEdit();
                tableWidget->setCellWidget(row, i, noteLineEdit);
                noteLineEdit->setText(args[i]);
                connect(noteLineEdit, &QLineEdit::editingFinished, this, [=]() {
                    QString id = tableWidget->item(row, 0)->text();
                    network->sendPacket(PacketID_EDIT_NOTE, id + ";" + noteLineEdit->text());
                });
            }
            else
            {
                QTableWidgetItem *item = new QTableWidgetItem(args[i]);
                if (isOffline && i > 3)
                {
                    item->setForeground(QBrush(Qt::gray));
                }
                else if (args[i] == "–û—Ñ—Ñ–ª–∞–π–Ω")
                {
                    isOffline = true;
                    item->setForeground(QBrush(Qt::red));
                }
                tableWidget->setItem(row, i, item);
            }
        }
        QPushButton *moreButton = new QPushButton("–ü–æ–¥—Ä–æ–±–Ω–µ–µ");
        connect(moreButton, &QPushButton::clicked, this, [=]() {
            QString id = tableWidget->item(row, 0)->text();
            network->sendPacket(PacketID_GET_FULL_INFO, id + ";–ó–∞ –Ω–µ–¥–µ–ª—é");
        });

        QPushButton *feedButton = new QPushButton("–†–∞—Å—á—ë—Ç –∫–æ—Ä–º–∞");
        connect(feedButton, &QPushButton::clicked, this, [=]() {
            QString ageText = tableWidget->item(row, 3)->text();
            int monthNum = ageText.leftRef(ageText.indexOf("–º")).toInt();
            int dayNum =
                ageText.midRef(ageText.indexOf(" ") + 1, ageText.indexOf("–¥") - ageText.indexOf(" ") - 1).toInt();
            int totalDays = monthNum * 30 + dayNum;
            float kg = 0.2 + (totalDays / 30.0) * 0.22;
            QMessageBox msgBox;
            msgBox.setText("–†–∞—Å—á—ë—Ç –∫–æ—Ä–º–∞ –Ω–∞ –¥–µ–Ω—å üêÆ");
            msgBox.setInformativeText(QString::number(kg, 'g', 2) + " –∫–≥");
            msgBox.exec();
        });

        QWidget *cellWidget = new QWidget();
        QHBoxLayout *layout = new QHBoxLayout(cellWidget);
        layout->setSpacing(0);
        layout->addWidget(moreButton);
        layout->addWidget(feedButton);
        layout->setContentsMargins(0, 0, 0, 0);
        cellWidget->setLayout(layout);

        tableWidget->setCellWidget(tableWidget->rowCount() - 1, 6, cellWidget);
        logToPanel("–°—Ç—Ä–æ–∫–∞ " + args[0] + " –¥–æ–±–∞–≤–ª–µ–Ω–∞");
    }
    break;
    case PacketID_UPDATE_ROW_CELL_VALUE: {
        int columnCount = tableWidget->columnCount();
        int changeCol = -1;
        for (int col = 0; col < columnCount; ++col)
        {
            QTableWidgetItem *headerItem = tableWidget->horizontalHeaderItem(col);
            if (headerItem && headerItem->text() == args[1])
            {
                changeCol = col;
                break;
            }
        }
        for (int row = 0; row < tableWidget->rowCount(); ++row)
        {
            QTableWidgetItem *item = tableWidget->item(row, 0);
            if (item && item->text() == args[0])
            {
                QTableWidgetItem *newItem = new QTableWidgetItem(args[2]);
                if (args[2] == "–û—Ñ—Ñ–ª–∞–π–Ω")
                {
                    newItem->setForeground(QBrush(Qt::red));
                }
                tableWidget->setItem(row, changeCol, newItem);
                return;
            }
        }
    }
    break;
    case PacketID_SEND_FULL_INFO: {
        InfoWindow *infoWindow = new InfoWindow(args, network);
        infoWindow->show();
    }
    break;
    }
}
